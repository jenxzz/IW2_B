<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Usuários</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

    <h2 class="mb-4 text-center">Cadastro de Usuários</h2>

    <form id="usuarioForm" class="row g-3 mb-3">
        <input type="hidden" id="usuarioId">
        <div class="col-md-4">
            <input type="text" class="form-control" id="nomeUsuario" placeholder="Nome completo" required>
        </div>
        <div class="col-md-4">
            <input type="email" class="form-control" id="emailUsuario" placeholder="E-mail" required>
        </div>
        <div class="col-md-2">
            <input type="password" class="form-control" id="senhaUsuario" placeholder="Senha" required>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="statusUsuario">
                <option value="1">Ativo</option>
                <option value="0">Inativo</option>
            </select>
        </div>
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-success">Salvar</button>
            <button type="button" class="btn btn-secondary" onclick="resetarFormulario()">Limpar</button>
        </div>
    </form>

    <div class="mb-3 d-flex gap-2">
        <input type="text" id="campoBusca" class="form-control" placeholder="Buscar por nome">
        <button class="btn btn-primary" onclick="buscarUsuarios()">Buscar</button>
        <button class="btn btn-outline-dark" onclick="listarUsuarios()">Listar Todos</button>
    </div>

    <table class="table table-striped" id="tabelaUsuarios">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        var API_URL = "http://localhost/IW2_B/prova/prova.php";

        document.getElementById('usuarioForm').onsubmit = function(e) {
            e.preventDefault();
            salvarUsuario();
        };

        function listarUsuarios(filtro) {
            var url = API_URL;
            if (filtro) url += "?pesquisa=" + encodeURIComponent(filtro);

            fetch(url)
            .then(response => response.json())
            .then(function(usuarios) {
                var tbody = document.querySelector("#tabelaUsuarios tbody");
                tbody.innerHTML = "";
                usuarios.forEach(function(u) {
                    var tr = document.createElement("tr");
                    tr.innerHTML = 
                        "<td>" + u.ID + "</td>" +
                        "<td>" + u.NOME + "</td>" +
                        "<td>" + u.GMAIL + "</td>" +
                        "<td>" + (u.ATIVO == 1 ? "Ativo" : "Inativo") + "</td>" +
                        "<td>" +
                        "<button class='btn btn-warning btn-sm' onclick='preencherEdicao(" + u.ID + ",\"" + u.NOME + "\",\"" + u.GMAIL + "\",\"" + u.SENHA + "\"," + u.ATIVO + ")'>Editar</button> " +
                        "<button class='btn btn-danger btn-sm' onclick='removerUsuario(" + u.ID + ")'>Excluir</button>" +
                        "</td>";
                    tbody.appendChild(tr);
                });
            });
        }

        function buscarUsuarios() {
            var termo = document.getElementById("campoBusca").value;
            listarUsuarios(termo);
        }

        function salvarUsuario() {
            var id = document.getElementById("usuarioId").value;
            var nome = document.getElementById("nomeUsuario").value;
            var email = document.getElementById("emailUsuario").value;
            var senha = document.getElementById("senhaUsuario").value;
            var status = parseInt(document.getElementById("statusUsuario").value);

            var dados = { ID: id, NOME: nome, GMAIL: email, SENHA: senha, ATIVO: status };

            if (id) {
                fetch(API_URL, {
                    method: "PUT",
                    body: JSON.stringify(dados),
                    headers: { "Content-Type": "application/json" }
                }).then(function() {
                    resetarFormulario();
                    listarUsuarios();
                });
            } else {
                fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(dados),
                    headers: { "Content-Type": "application/json" }
                }).then(function() {
                    resetarFormulario();
                    listarUsuarios();
                });
            }
        }

        function preencherEdicao(id, nome, gmail, senha, ativo) {
            document.getElementById("usuarioId").value = id;
            document.getElementById("nomeUsuario").value = nome;
            document.getElementById("emailUsuario").value = gmail;
            document.getElementById("senhaUsuario").value = senha;
            document.getElementById("statusUsuario").value = ativo;
        }

        function removerUsuario(id) {
            if (confirm("Tem certeza que deseja excluir este usuário?")) {
                fetch(API_URL + "?id=" + id, { method: "DELETE" })
                .then(function() {
                    listarUsuarios();
                });
            }
        }

        function resetarFormulario() {
            document.getElementById("usuarioForm").reset();
            document.getElementById("usuarioId").value = "";
        }

        listarUsuarios();
    </script>
</body>
</html>